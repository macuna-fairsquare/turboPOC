name: Check Migration Order

on:
  pull_request:
    branches:
      - main
      - dev
      - master
    paths:
      - 'Migrations/**'

jobs:
  check-order:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Check migration order
        run: |
          echo "Checking migration order..." from ${{ github.head_ref }} to ${{ github.base_ref }}
          # Fetch the target branch (base of the PR or default to dev)
          git fetch origin ${{ github.base_ref  }}

          # List migrations in the target branch
          git checkout origin/${{ github.base_ref }}
          ls
          if [ -d Migrations ]; then
            ls Migrations | sort > /tmp/migrations_base.txt
          else
            touch /tmp/migrations_base.txt
          fi

          # List migrations in the PR branch (current)
          git checkout -
          if [ -d Migrations ]; then
            ls Migrations | sort > /tmp/migrations_pr.txt
          else
            touch /tmp/migrations_pr.txt
          fi

          # Find new migrations in PR
          comm -13 /tmp/migrations_base.txt /tmp/migrations_pr.txt > /tmp/new_migrations.txt

          # Check if new migrations are appended and sorted
          cat /tmp/migrations_base.txt /tmp/migrations_pr.txt | uniq > /tmp/expected.txt
          ls | sort > /tmp/actual.txt

          if ! diff /tmp/expected.txt /tmp/actual.txt; then
            echo "New migration files are not appended in order!"
            echo "Expected order:"
            cat /tmp/expected.txt
            echo "Actual order:"
            cat /tmp/actual.txt
            exit 1
          fi